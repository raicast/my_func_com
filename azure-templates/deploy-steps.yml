# Azure DevOps template used to publish the package in the NPM registry and
# create a new corresponding release in the GitHub repository. 

parameters:
  - name: 'deployType'
    type: string
    default: publishPackage
    values:
      - publishPackage
  
  - name: 'packageVersion'
    type: string
    default: ''

  - name: 'githubToken'
    type: string
    default: ''

  - name: 'npmToken'
    type: string
    default: ''
    
steps:
  - template: ./make-build-steps.yml
    parameters:
      make: build
    
  - bash: |
      echo registry=https://registry.npmjs.com/ >> .npmrc
      echo \//registry.npmjs.org/:_authToken=$NPM_TOKEN >> .npmrc
    env:
      NPM_TOKEN: '${{ parameters.npmToken }}'
    displayName: 'Init .npmrc file'
  
    # When using an HTTPS url, you have to add the token to the CI/CD environment and 
    #Â then make sure to add this token as a password in the origin url before running release-it. 
  - script: |
      git config user.email "io-functions-commons@noreply.github.com"
      git config user.name "rcastino"   
      git config remote.origin.url https://rcastino:${GITHUB_TOKEN}@github.com/rcastino/my_func_com.git
      git config -l
         
      yarn release-it --ci --no-git.requireUpstream $PACKAGE_VERSION 
    env:
      GITHUB_TOKEN: '${{ parameters.githubToken }}'
      PACKAGE_VERSION: '${{ parameters.packageVersion }}'
    displayName: 'release-it'
  
